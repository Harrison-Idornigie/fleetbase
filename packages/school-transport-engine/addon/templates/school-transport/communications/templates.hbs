{{!-- Communication Templates Template --}}
<div class="school-transport-communication-templates">
    {{!-- Page Header --}}
    <div class="page-header">
        <div class="flex items-center justify-between mb-6">
            <div class="flex items-center space-x-4">
                <div class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center">
                    <FaIcon @icon="file-alt" class="text-blue-600 text-xl" />
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">Message Templates</h1>
                    <p class="text-gray-600">Manage reusable message templates for common communications</p>
                </div>
            </div>
            <div class="flex space-x-3">
                <LinkTo @route="school-transport.communications.new" class="btn btn-outline">
                    <FaIcon @icon="plus" class="mr-2" />
                    New Message
                </LinkTo>
                <button class="btn btn-primary" {{on "click" this.createTemplate}}>
                    <FaIcon @icon="plus" class="mr-2" />
                    Create Template
                </button>
            </div>
        </div>
    </div>

    {{!-- Filters and Search --}}
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Search Templates</label>
                <Input @type="text" @value={{this.searchQuery}} @placeholder="Search by name or content..."
                    class="form-input" {{on "input" this.updateSearch}} />
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Type</label>
                <select class="form-select" {{on "change" this.updateTypeFilter}}>
                    <option value="">All Types</option>
                    <option value="alert">Alert</option>
                    <option value="reminder">Reminder</option>
                    <option value="update">Update</option>
                    <option value="general">General</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Priority</label>
                <select class="form-select" {{on "change" this.updatePriorityFilter}}>
                    <option value="">All Priorities</option>
                    <option value="high">High</option>
                    <option value="normal">Normal</option>
                    <option value="low">Low</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Sort By</label>
                <select class="form-select" {{on "change" this.updateSortBy}}>
                    <option value="name">Name</option>
                    <option value="type">Type</option>
                    <option value="created_at">Created Date</option>
                    <option value="usage_count">Usage Count</option>
                </select>
            </div>
        </div>
    </div>

    {{!-- Templates Grid --}}
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {{#each this.templates as |template|}}
        <div
            class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden hover:shadow-md transition-shadow">
            {{!-- Template Header --}}
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        {{#if (eq template.type "alert")}}
                        <div class="w-8 h-8 rounded-full bg-red-100 flex items-center justify-center">
                            <FaIcon @icon="exclamation-triangle" class="text-red-600 text-sm" />
                        </div>
                        {{else if (eq template.type "reminder")}}
                        <div class="w-8 h-8 rounded-full bg-yellow-100 flex items-center justify-center">
                            <FaIcon @icon="clock" class="text-yellow-600 text-sm" />
                        </div>
                        {{else if (eq template.type "update")}}
                        <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center">
                            <FaIcon @icon="sync" class="text-blue-600 text-sm" />
                        </div>
                        {{else}}
                        <div class="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center">
                            <FaIcon @icon="bell" class="text-green-600 text-sm" />
                        </div>
                        {{/if}}
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">{{template.name}}</h3>
                            <p class="text-sm text-gray-600 capitalize">{{template.type}} â€¢ {{template.priority}}
                                priority</p>
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <button class="text-gray-400 hover:text-gray-600" {{on "click" (fn this.editTemplate template)}}
                            title="Edit Template">
                            <FaIcon @icon="edit" />
                        </button>
                        <button class="text-gray-400 hover:text-gray-600" {{on "click" (fn this.duplicateTemplate
                            template)}} title="Duplicate Template">
                            <FaIcon @icon="copy" />
                        </button>
                        <button class="text-gray-400 hover:text-red-600" {{on "click" (fn this.deleteTemplate
                            template)}} title="Delete Template">
                            <FaIcon @icon="trash" />
                        </button>
                    </div>
                </div>
            </div>

            {{!-- Template Content Preview --}}
            <div class="px-6 py-4">
                <p class="text-sm text-gray-700 line-clamp-3">{{template.content}}</p>
            </div>

            {{!-- Template Footer --}}
            <div class="px-6 py-4 bg-gray-50 border-t border-gray-200">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <span class="text-xs text-gray-500">
                            Used {{template.usage_count}} time{{if (gt template.usage_count 1) "s"}}
                        </span>
                        <span class="text-xs text-gray-500">
                            Created {{moment-format template.created_at "MMM DD, YYYY"}}
                        </span>
                    </div>
                    <div class="flex space-x-2">
                        {{#if template.send_via_email}}
                        <span
                            class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                            Email
                        </span>
                        {{/if}}
                        {{#if template.send_via_sms}}
                        <span
                            class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                            SMS
                        </span>
                        {{/if}}
                    </div>
                </div>
            </div>

            {{!-- Template Actions --}}
            <div class="px-6 py-4 border-t border-gray-200">
                <div class="flex space-x-3">
                    <button class="flex-1 btn btn-outline btn-sm" {{on "click" (fn this.useTemplate template)}}>
                        <FaIcon @icon="paper-plane" class="mr-1" />
                        Use Template
                    </button>
                    <button class="flex-1 btn btn-primary btn-sm" {{on "click" (fn this.previewTemplate template)}}>
                        <FaIcon @icon="eye" class="mr-1" />
                        Preview
                    </button>
                </div>
            </div>
        </div>
        {{/each}}
    </div>

    {{!-- Empty State --}}
    {{#if (eq this.templates.length 0)}}
    <div class="text-center py-12">
        <div class="w-24 h-24 rounded-full bg-gray-100 flex items-center justify-center mx-auto mb-4">
            <FaIcon @icon="file-alt" class="text-gray-400 text-3xl" />
        </div>
        <h3 class="text-lg font-medium text-gray-900 mb-2">No templates found</h3>
        <p class="text-gray-600 mb-6">
            {{#if this.searchQuery}}
            No templates match your search criteria.
            {{else}}
            Get started by creating your first message template.
            {{/if}}
        </p>
        <button class="btn btn-primary" {{on "click" this.createTemplate}}>
            <FaIcon @icon="plus" class="mr-2" />
            Create Template
        </button>
    </div>
    {{/if}}

    {{!-- Pagination --}}
    {{#if (gt this.templates.length 0)}}
    <div class="flex items-center justify-between mt-6">
        <div class="text-sm text-gray-700">
            Showing {{this.startIndex}} to {{this.endIndex}} of {{this.totalTemplates}} templates
        </div>
        <div class="flex space-x-2">
            <button class="btn btn-outline btn-sm" disabled={{not this.hasPreviousPage}} {{on "click"
                this.previousPage}}>
                <FaIcon @icon="chevron-left" class="mr-1" />
                Previous
            </button>
            <button class="btn btn-outline btn-sm" disabled={{not this.hasNextPage}} {{on "click" this.nextPage}}>
                Next
                <FaIcon @icon="chevron-right" class="ml-1" />
            </button>
        </div>
    </div>
    {{/if}}

    {{!-- Create/Edit Template Modal --}}
    {{#if this.showTemplateModal}}
    <div class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50" id="template-modal">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900">
                        {{#if this.editingTemplate}}
                        Edit Template
                        {{else}}
                        Create Template
                        {{/if}}
                    </h3>
                    <button class="text-gray-400 hover:text-gray-600" {{on "click" this.closeTemplateModal}}>
                        <FaIcon @icon="times" />
                    </button>
                </div>

                <form {{on "submit" this.saveTemplate}}>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Template Name *</label>
                            <Input @type="text" @value={{this.templateForm.name}} @placeholder="e.g., Route Delay Alert"
                                class="form-input" required />
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Type *</label>
                                <select class="form-select" {{on "change" (fn this.updateTemplateForm "type" )}}
                                    required>
                                    <option value="">Select Type</option>
                                    <option value="alert">Alert</option>
                                    <option value="reminder">Reminder</option>
                                    <option value="update">Update</option>
                                    <option value="general">General</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Priority *</label>
                                <select class="form-select" {{on "change" (fn this.updateTemplateForm "priority" )}}
                                    required>
                                    <option value="">Select Priority</option>
                                    <option value="high">High</option>
                                    <option value="normal">Normal</option>
                                    <option value="low">Low</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Subject *</label>
                            <Input @type="text" @value={{this.templateForm.subject}}
                                @placeholder="e.g., Important: Bus Route Update" class="form-input" required />
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Content *</label>
                            <Textarea @value={{this.templateForm.content}} @placeholder="Enter the message content..."
                                class="form-textarea" rows="6" required />
                            <p class="text-xs text-gray-500 mt-1">
                                You can use variables like {{student_name}}, {{route_name}}, {{pickup_time}}, etc.
                            </p>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Delivery Channels</label>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="checkbox" checked={{this.templateForm.send_via_email}} {{on "change"
                                        (fn this.updateTemplateForm "send_via_email" )}} class="form-checkbox" />
                                    <span class="ml-2 text-sm text-gray-700">Send via Email</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" checked={{this.templateForm.send_via_sms}} {{on "change" (fn
                                        this.updateTemplateForm "send_via_sms" )}} class="form-checkbox" />
                                    <span class="ml-2 text-sm text-gray-700">Send via SMS</span>
                                </label>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Tags (optional)</label>
                            <Input @type="text" @value={{this.templateForm.tags}}
                                @placeholder="e.g., emergency, weather, delay" class="form-input" />
                            <p class="text-xs text-gray-500 mt-1">Separate tags with commas</p>
                        </div>
                    </div>

                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" class="btn btn-outline" {{on "click" this.closeTemplateModal}}>
                            Cancel
                        </button>
                        <button type="submit" class="btn btn-primary" disabled={{this.isSaving}}>
                            {{#if this.isSaving}}
                            <FaIcon @icon="spinner" class="animate-spin mr-2" />
                            Saving...
                            {{else}}
                            {{#if this.editingTemplate}}
                            Update Template
                            {{else}}
                            Create Template
                            {{/if}}
                            {{/if}}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {{/if}}

    {{!-- Preview Modal --}}
    {{#if this.showPreviewModal}}
    <div class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50" id="preview-modal">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Template Preview</h3>
                    <button class="text-gray-400 hover:text-gray-600" {{on "click" this.closePreviewModal}}>
                        <FaIcon @icon="times" />
                    </button>
                </div>

                {{#if this.previewTemplate}}
                <div class="space-y-4">
                    <div>
                        <h4 class="font-medium text-gray-900">Subject:</h4>
                        <p class="text-gray-700 bg-gray-50 p-3 rounded">{{this.previewTemplate.subject}}</p>
                    </div>
                    <div>
                        <h4 class="font-medium text-gray-900">Content:</h4>
                        <div class="text-gray-700 bg-gray-50 p-3 rounded whitespace-pre-line">
                            {{this.previewTemplate.content}}</div>
                    </div>
                    <div class="flex items-center space-x-4 text-sm text-gray-600">
                        <span>Type: <strong>{{capitalize this.previewTemplate.type}}</strong></span>
                        <span>Priority: <strong>{{capitalize this.previewTemplate.priority}}</strong></span>
                        <span>Channels:
                            {{#if this.previewTemplate.send_via_email}}
                            <strong>Email</strong>
                            {{/if}}
                            {{#if (and this.previewTemplate.send_via_email this.previewTemplate.send_via_sms)}}
                            &
                            {{/if}}
                            {{#if this.previewTemplate.send_via_sms}}
                            <strong>SMS</strong>
                            {{/if}}
                        </span>
                    </div>
                </div>
                {{/if}}

                <div class="flex justify-end mt-6">
                    <button class="btn btn-primary" {{on "click" this.closePreviewModal}}>
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>
    {{/if}}
</div>